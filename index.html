<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- 
    ============================================================================
    BACKUP ATUALIZADO (VERS√ÉO 1.4 - BACKUP ADMIN)
    ============================================================================
    Cont√©m:
    - FUN√á√ÉO EXCLUSIVA DE BACKUP (EXPORTAR/IMPORTAR) PARA ADMIN
    - L√≥gica de setDoc (Upsert) para restaura√ß√£o de dados preservando IDs
    - Filtro por Local
    - Prote√ß√£o de Usu√°rio
    - Login com Senha Individual
    
    Para usar: Salve como "index.html".
    ============================================================================
    -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#D32F2F">
    <meta name="description" content="App de Inspe√ß√£o de Extintores e Hidrantes">
    
    <!-- Configura√ß√µes PWA iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TR FIRE">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/785/785116.png">
    
    <!-- Manifesto PWA -->
    <link rel="manifest" id="manifest-placeholder" href="data:application/json;base64,eyJuYW1lIjoiVFIgRklSRSIsInNob3J0X25hbWUiOiJUUiBGSVJFIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNEMzJGMkYiLCJ0aGVtZV9jb2xvciI6IiNEMzJGMkYiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0IiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzc4NS83ODUxMTYucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9LHsic3JjIjoiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvNzg1Lzc4NTExNi5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">

    <!-- Script de Garantia para o Nome do App -->
    <script>
        const manifestData = {
            "name": "TR FIRE",
            "short_name": "TR FIRE",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#D32F2F",
            "theme_color": "#D32F2F",
            "orientation": "portrait",
            "icons": [
                {"src": "https://cdn-icons-png.flaticon.com/512/785/785116.png", "sizes": "192x192", "type": "image/png"},
                {"src": "https://cdn-icons-png.flaticon.com/512/785/785116.png", "sizes": "512x512", "type": "image/png"}
            ]
        };
        const stringManifest = JSON.stringify(manifestData);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);
    </script>

    <title>TR FIRE Inspe√ß√µes</title>

    <!-- DEPEND√äNCIAS -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overscroll-behavior-y: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        input, textarea, select { font-size: 16px !important; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        #reader { width: 100%; height: 100%; overflow: hidden; background: black; }
        #reader video { object-fit: cover; width: 100% !important; height: 100% !important; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { red: '#D32F2F', orange: '#F57C00', black: '#212121', dark: '#121212' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-brand-dark h-screen w-full overflow-hidden text-gray-900 dark:text-gray-100">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { jsPDF } = window.jspdf;

        const LOGO_SRC = "logo.png"; 
        const FALLBACK_LOGO = "https://cdn-icons-png.flaticon.com/512/785/785116.png";

        // LISTA DE LOCAIS
        const LOCATION_OPTIONS = ["ANJUN", "AZUL CARGO", "AREAS COMUNS", "EQ. RESERVA", "LATAM", "MELI", "POWER SOURCE", "TOTAL EXP."];

        const generateUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });

        const formatDate = (dateStr) => {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('pt-BR', { 
                day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' 
            });
        };

        const LogoImage = ({ className }) => (
            <img 
                src={LOGO_SRC} 
                onError={(e) => {e.target.onerror = null; e.target.src=FALLBACK_LOGO}} 
                alt="Logo TR Fire" 
                className={className} 
            />
        );

        // 1. TELA DE RESPONS√ÅVEL
        const ResponsibleScreen = ({ onConfirm }) => {
            const [selectedName, setSelectedName] = useState("");
            const [password, setPassword] = useState("");

            // CONFIGURA√á√ÉO DE USU√ÅRIOS E SENHAS
            const CREDENTIALS = {
                "MARCO DUARTE": "MD4587",
                "RICARDO GRILLO": "RG6589",
                "RODRIGO UMBELINO": "RU7863",
                "RUBENS RODRIGUES": "RR4258",
                "THAWILLYS ROCHA": "Admin1605"
            };

            const inspectors = Object.keys(CREDENTIALS);
            const isLoginValid = selectedName && CREDENTIALS[selectedName] === password;

            return (
                <div className="flex flex-col h-full bg-brand-red p-6 items-center justify-center animate-fade-in relative">
                    <div className="w-40 h-40 mb-4 bg-white rounded-full p-4 shadow-2xl flex items-center justify-center">
                         <LogoImage className="w-full h-full object-contain" />
                    </div>
                    
                    <h1 className="text-white text-3xl font-extrabold tracking-tight mb-2 text-center">TR FIRE <span className="text-brand-orange">INSPE√á√ïES</span></h1>
                    <p className="text-white/80 text-sm mb-8">Sistema de Controle de Equipamentos</p>
                    
                    <div className="bg-white dark:bg-gray-900 p-6 rounded-2xl shadow-2xl w-full max-w-sm space-y-6">
                        <div>
                            <label className="text-sm font-bold text-gray-700 dark:text-gray-300 block mb-2">Respons√°vel pela Inspe√ß√£o *</label>
                            <div className="relative">
                                <select 
                                    value={selectedName} 
                                    onChange={(e) => { setSelectedName(e.target.value); setPassword(""); }} 
                                    className="w-full p-4 bg-gray-100 dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 focus:border-brand-orange outline-none dark:text-white appearance-none font-bold text-gray-700"
                                >
                                    <option value="">Selecione...</option>
                                    {inspectors.map(name => <option key={name} value={name}>{name}</option>)}
                                </select>
                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-700 dark:text-gray-300"><i className="fas fa-chevron-down"></i></div>
                            </div>
                        </div>

                        <div className={`transition-all duration-300 ${selectedName ? 'opacity-100 max-h-24' : 'opacity-50 max-h-24 pointer-events-none'}`}>
                            <label className="text-sm font-bold text-gray-700 dark:text-gray-300 block mb-2">Senha de Acesso *</label>
                            <div className="relative">
                                <input 
                                    type="password" 
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="Digite sua senha..."
                                    className="w-full p-4 bg-gray-100 dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 focus:border-brand-orange outline-none dark:text-white font-bold text-gray-700 placeholder-gray-400"
                                    disabled={!selectedName}
                                />
                                <div className="absolute inset-y-0 right-0 flex items-center px-4 text-gray-400">
                                    <i className={`fas ${isLoginValid ? 'fa-check text-green-500' : 'fa-lock'}`}></i>
                                </div>
                            </div>
                        </div>

                        <button 
                            onClick={() => isLoginValid && onConfirm(selectedName)} 
                            disabled={!isLoginValid}
                            className={`w-full py-4 rounded-xl text-xl font-bold shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 ${isLoginValid ? 'bg-brand-orange hover:bg-orange-600 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
                        >
                            INICIAR INSPE√á√ÉO <i className="fas fa-arrow-right"></i>
                        </button>
                    </div>

                    <div className="absolute bottom-4 w-full text-center space-y-2">
                        <div className="text-white/90 text-xs text-center mb-1 leading-relaxed font-medium">
                            <p>Copyright ¬© 2026 Fire Personality ME</p>
                            <p>Todos os direitos reservados</p>
                            <p>(Thawillys Rocha)</p>
                        </div>
                        <p className="text-white/40 text-xs">Vers√£o 1.4</p>
                    </div>
                </div>
            );
        };

        // 2. MENU PRINCIPAL
        const MenuScreen = ({ onNavigate, responsibleName, onStartInspection }) => {
            const [time, setTime] = useState(new Date());

            useEffect(() => { 
                const t = setInterval(() => setTime(new Date()), 1000); 
                return () => clearInterval(t); 
            }, []);

            return (
                <div className="flex flex-col h-full bg-white dark:bg-brand-dark p-6 animate-fade-in relative">
                    <div className="absolute top-0 left-0 w-full bg-gray-100 dark:bg-gray-800 p-2 px-6 flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
                        <span>Ol√°, <b>{responsibleName}</b></span>
                        <button onClick={() => window.location.reload()} className="text-brand-red font-bold">Sair</button>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center space-y-8 mt-6">
                        <div className="w-40 h-40">
                            <LogoImage className="w-full h-full object-contain filter drop-shadow-xl" />
                        </div>
                        <div className="text-center">
                            <h1 className="text-3xl font-extrabold tracking-tight">TR FIRE <span className="text-brand-orange">INSPE√á√ïES</span></h1>
                            <p className="text-gray-500 mt-2 font-mono text-sm">
                                {time.toLocaleDateString('pt-BR', {weekday: 'long', day:'numeric', month:'long'})}<br/>
                                {time.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}
                            </p>
                        </div>

                        <div className="text-center w-full -mb-2">
                            <h2 className="text-lg font-black text-gray-800 dark:text-white uppercase tracking-wider mb-1">LISTA DE EQUIPAMENTOS</h2>
                            <p className="text-sm text-gray-500 dark:text-gray-400 font-medium">Clique para escanear o QR code</p>
                        </div>

                        <div className="w-full space-y-4">
                            <button onClick={() => onStartInspection('EXTINTOR')} className="w-full py-5 bg-brand-red active:bg-red-800 text-white rounded-2xl text-xl font-bold shadow-lg flex items-center justify-center gap-4 transition-transform active:scale-95">
                                <i className="fas fa-fire-extinguisher text-3xl"></i> EXTINTORES
                            </button>
                            <button onClick={() => onStartInspection('HIDRANTE')} className="w-full py-5 bg-brand-orange active:bg-orange-800 text-white rounded-2xl text-xl font-bold shadow-lg flex items-center justify-center gap-4 transition-transform active:scale-95">
                                <i className="fas fa-faucet text-3xl"></i> HIDRANTES
                            </button>
                            <button onClick={() => onNavigate('list')} className="w-full py-5 bg-gray-800 active:bg-gray-900 text-white rounded-2xl text-xl font-bold shadow-lg flex items-center justify-center gap-4 transition-transform active:scale-95">
                                <i className="fas fa-database text-2xl"></i> HIST√ìRICO
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ScannerScreen = ({ onNavigate, onScanSuccess }) => {
            const scannerRef = useRef(null);

            useEffect(() => {
                const scanner = new Html5Qrcode("reader");
                scannerRef.current = scanner;
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };

                scanner.start(
                    { facingMode: "environment" }, 
                    config,
                    (decodedText) => {
                        scanner.stop().then(() => {
                            scanner.clear();
                            let data = { equipmentId: decodedText, equipmentName: decodedText };
                            try {
                                const parsed = JSON.parse(decodedText);
                                if(parsed.id || parsed.equipmentId) {
                                    data.equipmentId = parsed.id || parsed.equipmentId;
                                    data.equipmentName = parsed.name || parsed.equipmentName || decodedText;
                                }
                            } catch(e) {}
                            onScanSuccess(data);
                        }).catch(err => console.error(err));
                    },
                    (errorMessage) => {}
                ).catch(err => console.error(err));

                return () => {
                    if (scanner.isScanning) scanner.stop().then(() => scanner.clear()).catch(() => {});
                    else try { scanner.clear(); } catch(e) {}
                };
            }, []);

            return (
                <div className="flex flex-col h-full bg-black relative">
                    <div className="absolute top-4 left-4 z-20">
                        <button onClick={() => onNavigate('menu')} className="text-white bg-black/40 w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm"><i className="fas fa-arrow-left"></i></button>
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center bg-gray-900">
                        <div id="reader" className="w-full max-w-md bg-black"></div>
                        <p className="text-white/60 text-sm mt-4">Aponte para o QR Code</p>
                    </div>
                    <div className="p-6 bg-white dark:bg-brand-dark rounded-t-3xl z-10 safe-area-bottom">
                        <button onClick={() => onScanSuccess({equipmentId:"", equipmentName:""})} className="w-full py-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white font-bold rounded-xl flex items-center justify-center gap-2"><i className="fas fa-keyboard"></i> Digitar Manualmente</button>
                    </div>
                </div>
            );
        };

        const FormScreen = ({ initialData, onNavigate, onSave, responsibleName, inspectionType }) => {
            const [form, setForm] = useState({
                id: generateUUID(),
                type: inspectionType,
                equipmentId: initialData?.equipmentId || '',
                equipmentName: initialData?.equipmentName || '',
                moduleLocation: '', 
                hasId: null, // "Placa de Sinaliza√ß√£o?"
                floorSign: null, // "Sinaliza√ß√£o de Solo?"
                q1: null, 
                q2: null, 
                nextRecharge: '', 
                h_complete: null, h_unobstructed: null, h_seal_broken: null,
                nextHydro: '', obs: '', responsible: responsibleName, created_at: new Date().toISOString()
            });

            const save = () => {
                let required = false;
                // Valida√ß√£o comum
                if (!form.equipmentId || !form.moduleLocation) required = true;

                if (inspectionType === 'EXTINTOR') {
                    if (form.q1 === null || form.q2 === null || form.hasId === null || form.floorSign === null || !form.nextRecharge || !form.nextHydro) required = true;
                } else {
                    if (form.h_complete === null || form.h_unobstructed === null || form.h_seal_broken === null || !form.nextHydro) required = true;
                }
                
                if(required) return alert("Preencha todos os campos obrigat√≥rios (*)");
                onSave(form);
            };

            const handleDateInput = (v) => {
                v = v.replace(/\D/g, ''); 
                if (v.length > 6) v = v.slice(0, 6); 
                if (v.length >= 2) return v.slice(0, 2) + '/' + v.slice(2);
                return v;
            };

            const ColorSelect = ({ label, val, field, invert=false }) => {
                let bgClass = "bg-white dark:bg-gray-800";
                let textClass = "text-gray-700 dark:text-gray-200";
                if(val === true) {
                    bgClass = invert ? "bg-red-100 dark:bg-red-900 border-red-500" : "bg-green-100 dark:bg-green-900 border-green-500";
                    textClass = invert ? "text-red-700 dark:text-red-100" : "text-green-700 dark:text-green-100";
                } else if(val === false) {
                    bgClass = invert ? "bg-green-100 dark:bg-green-900 border-green-500" : "bg-red-100 dark:bg-red-900 border-red-500";
                    textClass = invert ? "text-green-700 dark:text-green-100" : "text-red-700 dark:text-red-100";
                }
                return (
                    <div className={`p-3 rounded-xl border ${val !== null ? 'border-2' : 'border-gray-200 dark:border-gray-700'} ${bgClass} shadow-sm transition-colors`}>
                        <p className={`font-bold mb-1 text-xs ${val !== null ? textClass : 'text-gray-500 dark:text-gray-400'}`}>{label} *</p>
                        <select value={val === null ? '' : (val ? 'true' : 'false')} onChange={(e) => { const v = e.target.value; setForm({...form, [field]: v === '' ? null : (v === 'true')}); }} className={`w-full bg-transparent font-bold focus:outline-none ${textClass} appearance-none`}>
                            <option value="">Selecionar...</option><option value="true">Sim</option><option value="false">N√£o</option>
                        </select>
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-black">
                    <div className="bg-white dark:bg-gray-900 p-4 shadow-sm flex items-center justify-between sticky top-0 z-20">
                        <div className="flex flex-col">
                            <div className="flex items-center">
                                <button onClick={() => onNavigate('menu')} className="w-8 h-8 flex items-center justify-center text-gray-600 dark:text-white mr-2"><i className="fas fa-arrow-left"></i></button>
                                <h2 className="text-lg font-bold text-gray-800 dark:text-white">{inspectionType === 'HIDRANTE' ? 'Insp. Hidrante' : 'Insp. Extintor'}</h2>
                            </div>
                            <span className="text-xs text-gray-500 ml-10">Resp: <b>{responsibleName}</b></span>
                        </div>
                        <button onClick={save} className="bg-brand-red text-white px-4 py-2 rounded-lg font-bold shadow-sm active:scale-95 transition-transform text-sm flex items-center"><i className="fas fa-save mr-2"></i> SALVAR</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-900">
                            <label className="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase">Equipamento</label>
                            <input value={form.equipmentId} onChange={e=>setForm({...form, equipmentId:e.target.value})} placeholder="ID do Equipamento" className="w-full bg-transparent font-mono font-bold text-lg border-b border-blue-300 focus:outline-none py-1 dark:text-white"/>
                            <input value={form.equipmentName} onChange={e=>setForm({...form, equipmentName:e.target.value})} placeholder="Nome / Descri√ß√£o" className="w-full bg-transparent text-sm mt-2 focus:outline-none dark:text-gray-300"/>
                        </div>

                        {/* Campo M√≥dulo/Local COMUM aos dois tipos */}
                        <div className="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm">
                            <label className="text-xs text-gray-500 block mb-1 font-bold">M√≥dulo/Local *</label>
                            <div className="relative">
                                <select 
                                    value={form.moduleLocation} 
                                    onChange={e=>setForm({...form, moduleLocation:e.target.value})} 
                                    className="w-full bg-transparent font-bold dark:text-white focus:outline-none appearance-none"
                                >
                                    <option value="">Selecione o local...</option>
                                    {LOCATION_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center text-gray-500"><i className="fas fa-chevron-down"></i></div>
                            </div>
                        </div>

                        {inspectionType === 'EXTINTOR' ? (
                            <>
                                <div className="grid grid-cols-2 gap-3"> 
                                    <ColorSelect label="Placa de Sinaliza√ß√£o?" field="hasId" val={form.hasId} />
                                    <ColorSelect label="Sinaliza√ß√£o de Solo?" field="floorSign" val={form.floorSign} />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <ColorSelect label="3. Viola√ß√£o no Lacre?" field="q1" val={form.q1} invert={true} />
                                    <ColorSelect label="4. Obstru√≠do?" field="q2" val={form.q2} invert={true} />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700">
                                        <label className="text-xs text-gray-500 block mb-1">Pr√≥x. Recarga *</label>
                                        <input type="tel" value={form.nextRecharge} onChange={e=>setForm({...form, nextRecharge: handleDateInput(e.target.value)})} placeholder="Ex: 12/2026" className="w-full bg-transparent font-bold dark:text-white"/>
                                    </div>
                                    <div className="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700">
                                        <label className="text-xs text-gray-500 block mb-1">Teste Hidro. *</label>
                                        <input type="tel" value={form.nextHydro} onChange={e=>setForm({...form, nextHydro: handleDateInput(e.target.value)})} placeholder="Ex: 12/2026" className="w-full bg-transparent font-bold dark:text-white"/>
                                    </div>
                                </div>
                            </>
                        ) : (
                            <>
                                <div className="grid grid-cols-2 gap-3">
                                    <ColorSelect label="1. Equip. Completo?" field="h_complete" val={form.h_complete} />
                                    <ColorSelect label="2. Equip. Desobstru√≠do?" field="h_unobstructed" val={form.h_unobstructed} />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700">
                                        <label className="text-xs text-gray-500 block mb-1">3. Pr√≥x. Teste Hidro. *</label>
                                        <input type="tel" value={form.nextHydro} onChange={e=>setForm({...form, nextHydro: handleDateInput(e.target.value)})} placeholder="Ex: 12/2026" className="w-full bg-transparent font-bold dark:text-white"/>
                                    </div>
                                    <ColorSelect label="4. Lacre Rompido?" field="h_seal_broken" val={form.h_seal_broken} invert={true} />
                                </div>
                            </>
                        )}
                        <textarea value={form.obs} onChange={e=>setForm({...form, obs:e.target.value})} placeholder="Observa√ß√µes (Opcional)..." className="w-full p-4 rounded-xl border-none shadow-sm h-32 resize-none bg-white dark:bg-gray-800 dark:text-white mb-4"></textarea>
                    </div>
                </div>
            );
        };

        const ListScreen = ({ data, onNavigate, onToggleDelete, onImport, currentUser }) => {
            const fileInputRef = useRef(null);
            const [showFilter, setShowFilter] = useState(false);
            const [showPdfModal, setShowPdfModal] = useState(false); 
            const [showBin, setShowBin] = useState(false);
            const [filters, setFilters] = useState({ startDate: '', endDate: '', type: '', responsible: '', moduleLocation: '' });
            
            const [viewMonth, setViewMonth] = useState(new Date().toISOString().slice(0, 7));

            // VERIFICA SE √â O ADMIN THAWILLYS ROCHA
            const isAdmin = currentUser === "THAWILLYS ROCHA";

            const responsibles = [...new Set(data.map(item => item.responsible).filter(Boolean))];

            const availableMonths = React.useMemo(() => {
                const months = new Set(data.filter(i => i.created_at).map(item => item.created_at.slice(0, 7)));
                months.add(new Date().toISOString().slice(0, 7));
                return Array.from(months).sort().reverse(); 
            }, [data]);

            const formatMonthDisplay = (yyyy_mm) => {
                if(!yyyy_mm) return "";
                const [year, month] = yyyy_mm.split('-');
                const date = new Date(year, month - 1);
                return date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            };

            const deletedData = data.filter(item => item.deleted).sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
            
            const activeData = data.filter(item => {
                if (item.deleted) return false;
                if (!item.created_at) return false;
                if (item.created_at.slice(0, 7) !== viewMonth) return false;

                const itemDate = new Date(item.created_at).setHours(0,0,0,0);
                const start = filters.startDate ? new Date(filters.startDate).setHours(0,0,0,0) : null;
                const end = filters.endDate ? new Date(filters.endDate).setHours(23,59,59,999) : null;

                if (start && itemDate < start) return false;
                if (end && itemDate > end) return false;
                if (filters.type && (item.type || 'EXTINTOR') !== filters.type) return false;
                if (filters.responsible && item.responsible !== filters.responsible) return false;
                if (filters.moduleLocation && item.moduleLocation !== filters.moduleLocation) return false;
                
                return true;
            });

            const displayList = showBin ? deletedData : activeData;

            // --- FUN√á√ÉO EXPORTAR (BACKUP) ---
            const handleExport = () => {
                if (!isAdmin) return;
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_trfire_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

            // --- FUN√á√ÉO IMPORTAR (RESTAURAR COM L√ìGICA SETDOC/UPSERT) ---
            const handleImportClick = () => {
                if (fileInputRef.current) fileInputRef.current.click();
            };

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!Array.isArray(importedData)) throw new Error("O arquivo n√£o √© uma lista v√°lida.");
                        // Chama a fun√ß√£o passada via props para processar a fus√£o dos dados
                        onImport(importedData);
                        // Limpa o input
                        event.target.value = null; 
                    } catch (err) {
                        alert("Erro ao ler o arquivo: " + err.message);
                    }
                };
                reader.readAsText(file);
            };

            const generateSpecificPDF = async (type) => {
                setShowPdfModal(false);
                const reportData = activeData.filter(item => (item.type || 'EXTINTOR') === type);

                if(reportData.length === 0) return alert(`Sem dados ATIVOS de ${type} para gerar relat√≥rio neste m√™s.`);

                const doc = new jsPDF({ orientation: "landscape" });
                
                doc.setFillColor(243, 244, 246); 
                doc.rect(0, 0, 297, 40, 'F');
                
                doc.setTextColor(33, 33, 33);
                doc.setFontSize(22); 
                
                const title = type === 'EXTINTOR' ? "CHECK-LIST EXTINTORES MENSAL" : "CHECK-LIST HIDRANTES MENSAL";
                doc.text(title, 14, 25);
                
                doc.setFontSize(10); 
                doc.setTextColor(100, 100, 100); 
                doc.text(`M√™s de Refer√™ncia: ${formatMonthDisplay(viewMonth).toUpperCase()} | Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 35);
                
                doc.setFontSize(9);
                doc.setTextColor(33, 33, 33); 
                doc.text("Parque Log√≠stico: AERO GRU I", 280, 28, { align: "right" });
                doc.text("Empresa: Vilella Assessoria em Seguran√ßa do Trabalho", 280, 35, { align: "right" });
                
                let body = [];
                let head = [];

                if (type === 'EXTINTOR') {
                    head = [['M√≥dulo/Local?', 'Equipamento', 'Data/Hora', 'Resp.', 'Placa Sinal.?', 'Pint. de Solo?', 'Lacre Rompido?', 'Eq. Obstru√≠do?', 'Pr√≥x. Recarga?', 'T. Hidro?', 'Observa√ß√µes']];
                    body = reportData.map(i => [
                        i.moduleLocation || '-', i.equipmentName, new Date(i.created_at).toLocaleDateString('pt-BR') + ' ' + new Date(i.created_at).toLocaleTimeString('pt-BR').slice(0,5), i.responsible || '-', i.hasId ? 'SIM' : 'N√ÉO', i.floorSign ? 'SIM' : 'N√ÉO', i.q1 ? 'SIM' : 'N√ÉO', i.q2 ? 'SIM' : 'N√ÉO', i.nextRecharge || '-', i.nextHydro || '-', i.obs || ''
                    ]);
                } else {
                    head = [['M√≥dulo/Local?', 'Equipamento', 'Data/Hora', 'Resp.', 'Eq. Completo?', 'Eq. Obstru√≠do?', 'Lacre Rompido?', 'Pr√≥x. T-Hidro', 'Observa√ß√µes']];
                    body = reportData.map(i => [
                        i.moduleLocation || '-', i.equipmentName, new Date(i.created_at).toLocaleDateString('pt-BR') + ' ' + new Date(i.created_at).toLocaleTimeString('pt-BR').slice(0,5), i.responsible || '-', i.h_complete ? 'SIM' : 'N√ÉO', i.h_unobstructed ? 'N√ÉO' : 'SIM', i.h_seal_broken ? 'SIM' : 'N√ÉO', i.nextHydro || '-', i.obs || ''
                    ]);
                }

                doc.autoTable({ 
                    head: head, body: body, startY: 45, theme: 'grid',
                    headStyles: { fillColor: [224, 224, 224], textColor: [0, 0, 0], fontStyle: 'bold', lineWidth: 0.1, lineColor: [200, 200, 200] },
                    styles: { fontSize: 8, textColor: [50, 50, 50], lineColor: [230, 230, 230], lineWidth: 0.1 },
                    alternateRowStyles: { fillColor: [255, 255, 255] }
                });
                doc.save(`TRFIRE_Relatorio_${type}_${viewMonth}.pdf`);
            };

            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-black relative">
                    {/* CABE√áALHO */}
                    <div className={`${showBin ? 'bg-red-800' : 'bg-gray-900'} text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-20 transition-colors duration-300`}>
                        <div className="flex items-center gap-2">
                            {showBin ? (
                                <button onClick={()=>setShowBin(false)} className="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-md flex items-center gap-2"><i className="fas fa-arrow-left"></i> VOLTAR</button>
                            ) : (
                                <button onClick={()=>onNavigate('menu')} className="bg-brand-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-md active:scale-95 transition-all flex items-center gap-2"><i className="fas fa-plus"></i> NOVA INSPE√á√ÉO</button>
                            )}
                            <span className="text-xs text-white/80 hidden sm:inline ml-2">{showBin ? 'Itens Exclu√≠dos' : `${displayList.length} registros`}</span>
                        </div>
                        
                        <div className="flex gap-4 items-center">
                            {!showBin && (
                                <>
                                    {/* BOT√ïES DE BACKUP - SOMENTE ADMIN */}
                                    {isAdmin && (
                                        <>
                                            <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" />
                                            <button onClick={handleExport} title="Exportar Backup" className="text-blue-400 hover:text-blue-300"><i className="fas fa-file-export text-xl"></i></button>
                                            <button onClick={handleImportClick} title="Importar Backup" className="text-green-400 hover:text-green-300"><i className="fas fa-file-import text-xl"></i></button>
                                            <div className="w-px h-6 bg-gray-600 mx-1"></div>
                                        </>
                                    )}

                                    <button onClick={() => setShowFilter(!showFilter)} title="Filtrar"><i className="fas fa-filter text-xl text-yellow-400"></i></button>
                                    <div className="w-px h-6 bg-gray-600 mx-1"></div>
                                    <button onClick={() => setShowPdfModal(true)} title="Gerar PDF"><i className="fas fa-file-pdf text-xl text-white"></i></button>
                                    <div className="w-px h-6 bg-gray-600 mx-1"></div>
                                </>
                            )}
                            {/* BOT√ÉO LIXEIRA TOPO */}
                            <button onClick={() => setShowBin(!showBin)} title={showBin ? "Ver Hist√≥rico" : "Ver Lixeira"} className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${showBin ? 'bg-white text-red-800' : 'bg-red-900/50 text-red-300 hover:bg-red-900 hover:text-white'}`}>
                                <i className={`fas ${showBin ? 'fa-list' : 'fa-trash'}`}></i>
                            </button>
                        </div>
                    </div>

                    {/* Modais omitidos para brevidade (PDF e Filtro continuam iguais) */}
                    {showPdfModal && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                            <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-sm animate-fade-in text-center">
                                <h3 className="text-lg font-bold mb-2 dark:text-white">Gerar Relat√≥rio</h3>
                                <p className="text-sm font-bold text-brand-red mb-6 uppercase border-b pb-2">{formatMonthDisplay(viewMonth)}</p>
                                <div className="space-y-3">
                                    <button onClick={() => generateSpecificPDF('EXTINTOR')} className="w-full py-3 bg-brand-red text-white font-bold rounded-xl shadow-md active:scale-95">Relat√≥rio de EXTINTORES</button>
                                    <button onClick={() => generateSpecificPDF('HIDRANTE')} className="w-full py-3 bg-brand-orange text-white font-bold rounded-xl shadow-md active:scale-95">Relat√≥rio de HIDRANTES</button>
                                    <button onClick={() => setShowPdfModal(false)} className="w-full py-3 bg-gray-200 text-gray-700 font-bold rounded-xl mt-2">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showFilter && !showBin && (
                        <div className="absolute top-16 right-4 z-50 bg-white dark:bg-gray-800 p-4 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 w-64 animate-fade-in">
                            <h3 className="font-bold mb-3 dark:text-white text-sm uppercase">Filtrar por</h3>
                            <div className="space-y-3">
                                <div><label className="text-xs text-gray-500 block mb-1">De</label><input type="date" value={filters.startDate} onChange={e=>setFilters({...filters, startDate: e.target.value})} className="w-full p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm dark:text-white" /></div>
                                <div><label className="text-xs text-gray-500 block mb-1">At√©</label><input type="date" value={filters.endDate} onChange={e=>setFilters({...filters, endDate: e.target.value})} className="w-full p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm dark:text-white" /></div>
                                <div><label className="text-xs text-gray-500 block mb-1">Tipo</label><select value={filters.type} onChange={e=>setFilters({...filters, type: e.target.value})} className="w-full p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm dark:text-white"><option value="">Todos</option><option value="EXTINTOR">Extintor</option><option value="HIDRANTE">Hidrante</option></select></div>
                                <div><label className="text-xs text-gray-500 block mb-1">Respons√°vel</label><select value={filters.responsible} onChange={e=>setFilters({...filters, responsible: e.target.value})} className="w-full p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm dark:text-white"><option value="">Todos</option>{responsibles.map(r => <option key={r} value={r}>{r}</option>)}</select></div>
                                <div>
                                    <label className="text-xs text-gray-500 block mb-1">M√≥dulo/Local</label>
                                    <select value={filters.moduleLocation} onChange={e=>setFilters({...filters, moduleLocation: e.target.value})} className="w-full p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm dark:text-white">
                                        <option value="">Todos</option>
                                        {LOCATION_OPTIONS.map(l => <option key={l} value={l}>{l}</option>)}
                                    </select>
                                </div>
                                <div className="flex gap-2 pt-2"><button onClick={() => setFilters({startDate:'', endDate:'', type:'', responsible:'', moduleLocation:''})} className="flex-1 py-1 text-xs font-bold text-gray-500 bg-gray-200 dark:bg-gray-700 rounded">Limpar</button><button onClick={() => setShowFilter(false)} className="flex-1 py-1 text-xs font-bold text-white bg-brand-red rounded">Fechar</button></div>
                            </div>
                        </div>
                    )}
                    
                    {!showBin && (
                        <div className="bg-gray-100 dark:bg-gray-900 p-3 border-b border-gray-200 dark:border-gray-700 sticky top-[72px] z-10">
                            <div className="relative">
                                 <select value={viewMonth} onChange={(e) => setViewMonth(e.target.value)} className="w-full p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-white font-bold appearance-none cursor-pointer uppercase text-center">
                                    {availableMonths.map(month => <option key={month} value={month}>{formatMonthDisplay(month).toUpperCase()}</option>)}
                                </select>
                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500"><i className="fas fa-calendar-alt"></i></div>
                            </div>
                        </div>
                    )}

                    <div className="flex-1 overflow-y-auto p-3 space-y-3">
                        {displayList.length === 0 && <div className="text-center text-gray-500 mt-10">{showBin ? "Lixeira vazia." : `Nenhum registro em ${formatMonthDisplay(viewMonth)}.`}</div>}
                        
                        {displayList.map(item => {
                            const isHid = item.type === 'HIDRANTE';
                            const statusColor = isHid 
                                ? (item.h_complete && item.h_unobstructed && !item.h_seal_broken ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700')
                                : (!item.q1 && !item.q2 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700');
                            const statusText = isHid
                                ? (item.h_complete && item.h_unobstructed && !item.h_seal_broken ? 'OK' : 'IRREGULAR')
                                : (!item.q1 ? 'OK' : 'VIOLADO');

                            return (
                                <div key={item.id} className={`p-4 rounded-xl shadow-sm border-l-4 flex justify-between items-center transition-all ${showBin ? 'bg-red-50 dark:bg-red-900/10 border-red-500 opacity-80' : 'bg-white dark:bg-gray-800 border-brand-red'}`}>
                                    <div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-xs font-bold bg-gray-200 dark:bg-gray-700 px-1 rounded text-gray-600 dark:text-gray-300">{item.type || 'EXT'}</span>
                                            <span className="font-bold text-gray-800 dark:text-white">{item.equipmentName}</span>
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1 flex gap-2">
                                            <span><i className="far fa-clock mr-1"></i>{formatDate(item.created_at)}</span>
                                            <span className="text-gray-400">| {item.responsible}</span>
                                        </div>
                                        {!showBin && (
                                            <span className={`inline-block mt-1 text-[10px] px-2 py-0.5 rounded font-bold ${statusColor}`}>{statusText}</span>
                                        )}
                                    </div>
                                    <div className="flex flex-col items-end gap-2">
                                        {/* BOT√ÉO DE A√á√ÉO: EXCLUIR OU RESTAURAR */}
                                        {showBin ? (
                                            <button 
                                                onClick={() => {
                                                    if (item.responsible !== currentUser) {
                                                        alert("üö´ A√ß√£o Negada: Permitido somente pelo usu√°rio " + item.responsible + ".");
                                                        return;
                                                    }
                                                    onToggleDelete(item.id, false);
                                                }}
                                                className="bg-green-100 text-green-600 hover:bg-green-200 w-10 h-10 rounded-full flex items-center justify-center shadow-sm transition-all active:scale-95"
                                                title="Restaurar"
                                            >
                                                <i className="fas fa-trash-restore"></i>
                                            </button>
                                        ) : (
                                            <button 
                                                onClick={() => {
                                                    if (item.responsible !== currentUser) {
                                                        alert("üö´ A√ß√£o Negada: Permitido somente pelo usu√°rio " + item.responsible + ".");
                                                        return;
                                                    }
                                                    if(confirm("Mover para lixeira?")) onToggleDelete(item.id, true);
                                                }}
                                                className="bg-gray-100 text-red-500 hover:bg-red-50 w-10 h-10 rounded-full flex items-center justify-center shadow-sm transition-all active:scale-95"
                                                title="Excluir"
                                            >
                                                <i className="fas fa-trash"></i>
                                            </button>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [page, setPage] = useState('responsible');
            const [responsible, setResponsible] = useState('');
            const [inspectionType, setInspectionType] = useState('EXTINTOR');
            const [db, setDb] = useState(() => { try { const saved = localStorage.getItem('trfire_db'); return saved ? JSON.parse(saved) : []; } catch (e) { return []; } });
            const [scanRes, setScanRes] = useState(null);
            
            useEffect(() => { localStorage.setItem('trfire_db', JSON.stringify(db)); }, [db]);
            
            const handleStartInspection = (type) => { setInspectionType(type); setPage('scan'); };
            
            const handleToggleDelete = (id, status) => {
                setDb(db.map(item => item.id === id ? {...item, deleted: status} : item));
            };

            // L√ìGICA DE IMPORTA√á√ÉO TIPO "setDoc" (UPSERT)
            const handleImportData = (newData) => {
                setDb(prevDb => {
                    const dbMap = new Map(prevDb.map(item => [item.id, item]));
                    newData.forEach(item => {
                        // Se o ID j√° existe, sobrescreve (atualiza). Se n√£o, cria.
                        // Isso simula o setDoc({ ...data }, { merge: true }) do Firebase
                        dbMap.set(item.id, item); 
                    });
                    return Array.from(dbMap.values());
                });
                alert("Backup restaurado com sucesso! Dados mesclados.");
            };

            // Placeholder para futura implementa√ß√£o Firebase
            // const futureFirebaseRestore = async (data) => {
            //    data.forEach(async (item) => {
            //       await setDoc(doc(db, "inspections", item.id), item, { merge: true });
            //    });
            // }

            return (
                <>
                    {page === 'responsible' && <ResponsibleScreen onConfirm={(name) => { setResponsible(name); setPage('menu'); }} />}
                    {page === 'menu' && <MenuScreen onNavigate={setPage} responsibleName={responsible} onStartInspection={handleStartInspection} />}
                    {page === 'scan' && <ScannerScreen onNavigate={setPage} onScanSuccess={(d)=>{setScanRes(d); setPage('form')}} />}
                    {page === 'form' && <FormScreen initialData={scanRes} onNavigate={setPage} responsibleName={responsible} inspectionType={inspectionType} onSave={(d)=>{setDb([d, ...db]); setPage('list');}} />}
                    {page === 'list' && <ListScreen data={db} onNavigate={setPage} onToggleDelete={handleToggleDelete} onImport={handleImportData} currentUser={responsible} />}
                </>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    self.addEventListener('install', (e) => { self.skipWaiting(); });
                    self.addEventListener('activate', (e) => { return self.clients.claim(); });
                    self.addEventListener('fetch', (e) => {});
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl).then(reg => console.log('SW OK')).catch(err => console.log('SW Err:', err));
            });
        }
    </script>
</body>
</html>